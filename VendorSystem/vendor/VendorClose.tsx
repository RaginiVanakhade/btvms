import { useState, useMemo, useEffect } from 'react';
import { useQuery } from '@tanstack/react-query';
import dayjs from 'dayjs';

import UniversalDialog from 'components/popup/UniversalDialog';
import VendorCustomGrid from 'components/grid/VednorCustomGrid';
import ActionButtonsGroup from 'components/buttons/ActionButtonsGroup';
import VendorRequestFormDisAct from 'pages/VendorSystem/forms/VendorRequestFormDisAct';

import { ColDef } from 'ag-grid-community';
import { TUniversalDialogProps } from 'types/types.UniversalDialog';
import { TAvailableActionButtons } from 'types/types.actionButtonsGroups';
import { TVendor } from '../vendorTypes/TVendor';
import * as XLSX from 'xlsx';
import { MoreOutlined } from '@ant-design/icons';
import { FormattedMessage, useIntl } from 'react-intl';
import { IconButton, Menu, MenuItem } from '@mui/material';

import useAuth from 'hooks/useAuth';
import VendorSerivceInstance from 'service/wms/service.vendor';
import { formatDateOnly } from 'utils/dateFormatter';

type VendorCloseProps = {
  triggerAddPopup?: boolean;
  onAddPopupHandled?: () => void;
};

const VendorClose = ({ triggerAddPopup, onAddPopupHandled }: VendorCloseProps) => {
  const { user } = useAuth();

  // Menu state
  const [anchorEl, setAnchorEl] = useState<null | HTMLElement>(null);
  const openMenu = Boolean(anchorEl);
  const handleMenuClick = (event: React.MouseEvent<HTMLElement>) => setAnchorEl(event.currentTarget);
  const handleMenuClose = () => setAnchorEl(null);
  const intl = useIntl();

  // Auto-open popup when Add button is clicked from parent
  useEffect(() => {
    if (triggerAddPopup) {
      openVendorPopup();
      onAddPopupHandled?.();
    }
  }, [triggerAddPopup]);

  const [VendorFormPopup, setVendorFormPopup] = useState<TUniversalDialogProps>({
    action: { open: false, fullWidth: true },
    title: intl.formatMessage({ id: 'EditVendorRequest' }) || 'Edit Vendor Request',
    data: { existingData: {}, isEditMode: true, isViewMode: false }
  });

  const handleActions = (actionType: string, rowOriginal: TVendor) => {
    if (actionType === 'view') {
      openVendorPopup(rowOriginal, true);
    }
  };

  const handleMenuAction = (action: string) => {
    handleMenuClose();

    if (action === 'export') {
      if (!vendorData || vendorData.length === 0) {
        alert(intl.formatMessage({ id: 'NoDataToExport' }) || 'No data available to export!');
        return;
      }

      const worksheet = XLSX.utils.json_to_sheet(vendorData);
      const workbook = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(workbook, worksheet, 'VendorRequests');
      XLSX.writeFile(workbook, `VendorRequests_${dayjs().format('YYYYMMDD_HHmmss')}.xlsx`);
    } else if (action === 'print') {
      if (!vendorData || vendorData.length === 0) {
        alert(intl.formatMessage({ id: 'NoDataToPrint' }) || 'No data available to print!');
        return;
      }

      // âœ… Build printable table
      const printWindow = window.open('', '', 'width=900,height=650');
      if (printWindow) {
        printWindow.document.write(`
          <html>
            <head>
              <title>{intl.formatMessage({ id: 'VendorRequestsClosed' }) || 'Vendor Requests - Closed'}</title>
              <style>
                table {
                  width: 100%;
                  border-collapse: collapse;
                  font-size: 12px;
                  font-family: Arial, sans-serif;
                }
                th, td {
                  border: 1px solid #ccc;
                  padding: 6px;
                  text-align: left;
                }
                th {
                  background: #f5f5f5;
                }
              </style>
            </head>
            <body>
                    <h2>{intl.formatMessage({ id: 'ClosedVendorRequests' }) || 'Closed Vendor Requests'}</h2>
              <table>
                <thead>
                  <tr>
                    <th>{intl.formatMessage({ id: 'DocumentNumber' }) || 'Document Number'}</th>
              <th>{intl.formatMessage({ id: 'DocumentDate' }) || 'Document Date'}</th>
              <th>{intl.formatMessage({ id: 'RefDocNo' }) || 'Ref Doc No'}</th>
              <th>{intl.formatMessage({ id: 'InvoiceNumber' }) || 'Invoice Number'}</th>
              <th>{intl.formatMessage({ id: 'InvoiceDate' }) || 'Invoice Date'}</th>
              <th>{intl.formatMessage({ id: 'Remarks' }) || 'Remarks'}</th>
              <th>{intl.formatMessage({ id: 'ERPDocNo' }) || 'ERP Doc No'}</th>
                  </tr>
                </thead>
                <tbody>
                  ${vendorData
            .map(
              (row: any) => `
                      <tr>
                        <td>${row.DOC_NO || ''}</td>
                        <td>${formatDateOnly(row.DOC_DATE)}</td>
                        <td>${row.REF_DOC_NO || ''}</td>
                        <td>${row.INVOICE_NUMBER || ''}</td>
                        <td>${formatDateOnly(row.INVOICE_DATE)}</td>
                        <td>${row.REMARKS || ''}</td>
                        <td>${row.ERP_DOC_NO || ''}</td>
                      </tr>
                    `
            )
            .join('')}
                </tbody>
              </table>
            </body>
          </html>
        `);

        printWindow.document.close();
        printWindow.print();
      }
    }
  };

  const openVendorPopup = (data = {}, isEditMode = false) => {
    setVendorFormPopup({
      action: { open: true, fullWidth: true },
      title: isEditMode
        ? intl.formatMessage({ id: 'EditPurchaseInvoices' }) || 'Edit Purchase Invoices'
        : intl.formatMessage({ id: 'AddPurchaseInvoices' }) || 'Add Purchase Invoices',
      data: {
        existingData: isEditMode ? data : {},
        isEditMode,
        isViewMode: false
      }
    });
  };

  const closeVendorPopup = () => {
    setVendorFormPopup((prev) => ({
      ...prev,
      action: { ...prev.action, open: false }
    }));
  };

  const columnDefs = useMemo<ColDef[]>(
    () => [
      { field: 'DOC_NO', headerName: 'Doc No', width: 130, sortable: true, filter: true, cellStyle: { fontSize: '0.775rem' } },
      {
        field: 'DOC_DATE',
        headerName: 'Doc Date',
        width: 150,
        sortable: true,
        filter: true,
        valueFormatter: (params) => formatDateOnly(params.value)
      },
      {
        field: 'REF_DOC_NO', headerName: intl.formatMessage({ id: 'RefDocNo' }) || 'Ref Doc No',
        width: 120, sortable: true, filter: true
      },
      {
        field: 'INVOICE_NUMBER', headerName: intl.formatMessage({ id: 'InvoiceNumber' }) || 'Invoice Number',
        width: 150, sortable: true, filter: true
      },
      {
        field: 'INVOICE_DATE',
        headerName: intl.formatMessage({ id: 'InvoiceDate' }) || 'Invoice Date',
        width: 130,
        sortable: true,
        filter: true,
        valueFormatter: (params) => formatDateOnly(params.value)
      },
      {
        field: 'REMARKS',
        headerName: intl.formatMessage({ id: 'Remarks' }) || 'Remarks',
        width: 320,
        sortable: true,
        filter: true,
        wrapText: true,
        autoHeight: true
      },
      {
        field: 'ERP_DOC_NO',
        headerName: intl.formatMessage({ id: 'ERPDocNo' }) || 'ERP Doc No',
        width: 130,
        sortable: true,
        filter: true
      },
      {
        headerName: intl.formatMessage({ id: 'Actions' }) || 'Actions',
        width: 120,
        cellRenderer: (params: { data: any }) => {
          const data = params.data;
          const actionButtons: TAvailableActionButtons[] = ['view'];
          return <ActionButtonsGroup handleActions={(action) => handleActions(action, data)} buttons={actionButtons} />;
        }
      }
    ],
    []
  );

  const sql_string = `
   SELECT * 
   FROM VW_TR_AC_LPO_HEADER_CLOSED
   WHERE FINAL_APPROVED = 'YES'
   ORDER BY DOC_NO DESC`;

  const { data: vendorData, refetch: refetchVendorData } = useQuery({
    queryKey: ['vendor_request_list', sql_string],
    queryFn: async () => {
      return await VendorSerivceInstance.executeRawSql(sql_string);
    }
  });


  console.log("sql string CONFIRM", sql_string)

  return (
    <div className="flex flex-col space-y-2">
      <div style={{ position: 'relative' }}>
        <div style={{ position: 'absolute', right: 0, zIndex: 2 }}>
          <IconButton
            aria-label={intl.formatMessage({ id: 'MoreOptions' }) || 'more'}
            aria-controls={openMenu ? 'vendor-inprogress-menu' : undefined}
            aria-haspopup="true"
            aria-expanded={openMenu ? 'true' : undefined}
            onClick={handleMenuClick}
            size="small"
            sx={{
              background: '#fff',
              boxShadow: 1,
              border: '1px solid #e0e0e0',
              '&:hover': { background: '#f5f5f5' }
            }}
          >
            <MoreOutlined />
          </IconButton>
          <Menu
            id="vendor-inprogress-menu"
            anchorEl={anchorEl}
            open={openMenu}
            onClose={handleMenuClose}
            anchorOrigin={{ vertical: 'bottom', horizontal: 'right' }}
            transformOrigin={{ vertical: 'top', horizontal: 'right' }}
          >
            <MenuItem onClick={() => handleMenuAction('export')}>
              <FormattedMessage id="Export" />
            </MenuItem>
            <MenuItem onClick={() => handleMenuAction('print')}>
              <FormattedMessage id="Print" />
            </MenuItem>
          </Menu>
        </div>

        <VendorCustomGrid
          rowData={vendorData || []}
          columnDefs={columnDefs}
          rowHeight={20}
          height="470px"
          headerHeight={30}
          pagination
          defaultColDef={{ cellStyle: { fontSize: '0.775rem' } }}
          paginationPageSizeSelector={[10, 50, 100, 500, 2000]}
          paginationPageSize={10}
        />
      </div>
      {!!VendorFormPopup.action.open && (
        <UniversalDialog
          action={{
            ...VendorFormPopup.action,
            maxWidth: 'xl',
            fullWidth: true
          }}
          onClose={() => {
            closeVendorPopup();
            refetchVendorData();
          }}
          title={VendorFormPopup.title}
          hasPrimaryButton={false}
        >
          <VendorRequestFormDisAct
            ac_code={user?.loginid ?? ''}
            isEditMode={VendorFormPopup?.data?.isEditMode}
            requestData={VendorFormPopup?.data?.existingData}
            requestNumber={VendorFormPopup?.data?.existingData?.Request_number}
            hideAttachIcon={true}
            onClose={() => {
              closeVendorPopup();
              refetchVendorData();
            }}
          // onTabChange={(tabIndex) => {
          //   setVendorFormPopup((prev) => ({
          //     ...prev,
          //     data: { ...prev.data, activeTab: tabIndex }
          //   }));
          // }}
          />
        </UniversalDialog>
      )}
    </div>
  );
};

export default VendorClose;
